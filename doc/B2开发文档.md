# 1.网络
通过网线连接B2和电脑，需使用转接器连接，然后将电脑的有线连接ip修改为192.168.123.222  
然后安装ssh：sudo apt-get install openssh-server  
启动ssh服务：sudo systemctl start ssh   
检查ssh服务状态：sudo systemctl status ssh

B2有主控PC和用户PC，用户PC可选配多块，默认配置为1块。  
主控PC IP为192.168.123.161，不可登录不可开发。  
用户PC IP为192.168.123.164，用户名unitree，密码Unitree0408。  
可选配的开发PC，地址为192.168.123.162/163/165, 用户名unitree，密码Unitree0408。  

```cmd
ssh unitree@192.168.123.164
```

输入密码进入b2的板载电脑终端  
```cmd
./nomachine.sh
```

解决不能上网问题：将路由器的网段改为123网段，然后在狗的终端输入
```cmd
sudo route add default gw 192.168.123.1
```

无线网卡连接
```cmd
sudo route add default gw 172.16.20.1   
ssh unitree@172.16.20.203   
ssh unitree@192.168.123.164
```

无法选择wifi
```bash
sudo systemctl restart NetworkManager
```

终端直接连接wifi: 
```cmd
sudo nmcli device wifi connect "清华4F" password "qinghua2022"
```

# 2.依赖库安装
## 按照[宇树提供的ros2包](https://github.com/unitreerobotics/unitree_ros2)安装unitree_ros2 获取机器人的相关数据与接口
```cmd
git clone https://github.com/unitreerobotics/unitree_ros2.git
```


## [dddmr_navigation](https://github.com/dfl-rlab/dddmr_navigation/tree/main)
```cmd
git clone https://github.com/dfl-rlab/dddmr_navigation.git
```

### 安装安装包出现依赖问题使用该行命令
```cmd
sudo apt-get install -f
```

### 编译时会出现报错pcl1.12.1与pcl1.15版本  
下载pcl1.15版本：
```cmd
git clone -b pcl-1.15.0 https://github.com/PointCloudLibrary/pcl.git
cd pcl
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local
make -j$(nproc)  # 使用所有可用的处理器核心进行并行构建
sudo make install
```
安装了PCL1.15后编译成功

### 无法加载共享库 libpcl_io_ply.so.1.15
```cmd
sudo apt install plocate
locate libpcl_io_ply.so
rosdepc install --from-paths src --ignore-src -r -y
sudo rm -rf /usr/local/lib/libpcl*
sudo rm -rf /usr/local/include/pcl-1.15
sudo rm -rf /usr/local/share/pcl-1.15
sudo ldconfig
gdb --args /home/unitree/dddmr_navigation/install/lego_loam_bor/lib/lego_loam_bor/lego_loam   --ros-args   --params-file /home/unitree/dddmr_navigation/install/lego_loam_bor/share/lego_loam_bor/config/loam_rs32_config.yaml   -r /lslidar_point_cloud:=/rslidar_points   -r /odom:=/dog_odom
```

# 3.docker

创建 drop-in 目录
```cmd
sudo mkdir -p /etc/systemd/system/docker.service.d
```

写入代理配置
```cmd
sudo tee /etc/systemd/system/docker.service.d/http-proxy.conf << 'EOF'
[Service]
Environment="HTTP_PROXY=http://127.0.0.1:7897/"
Environment="HTTPS_PROXY=http://127.0.0.1:7897/"
Environment="NO_PROXY=localhost,127.0.0.1,::1"
EOF
```

重载并重启 Docker
```cmd
sudo systemctl daemon-reload
sudo systemctl restart docker
```

验证环境变量
```cmd
systemctl show --property=Environment docker
```

这次你应该能看到类似：
```cmd
Environment=HTTP_PROXY=http://127.0.0.1:7897/…
```

# 4.ros2 topic
以下是针对您提供的ROS2话题列表的详细分析和解释。我将基于ROS2的标准话题命名惯例、Unitree机器人（尤其是B2系列）的常见配置、SLAM/导航栈（如LIO-SAM、Nav2）、以及LiDAR（如RoboSense）等知识来逐一解释这些话题的可能含义。这些解释是基于通用ROS生态和开源文档的推断（我无法直接访问您的代码库或互联网搜索），如果某些话题是自定义的或特定于您的系统，请提供更多上下文以确认。

我将话题分组整理，便于阅读：

* **标准ROS话题**：ROS核心功能。
* **Unitree机器人特定话题**：与Unitree B2硬件/运动控制相关。
* **SLAM/定位/映射话题**：LIO-SAM或其他SLAM模块。
* **导航/规划话题**：Nav2或自定义导航。
* **API和服务话题**：请求/响应接口。
* **传感器/视觉话题**：摄像头、LiDAR等。
* **其他/杂项话题**：状态、控制等。

如果话题含义不确定，我会标注为“推测”，建议您使用`ros2 topic info <topic>`命令查看类型/发布者，或检查节点日志/文档。

## 1. 标准ROS话题

这些是ROS2核心或常用包（如Nav2）中的标准话题。

* /initialpose：设置机器人初始位姿（PoseWithCovarianceStamped），常用于AMCL或SLAM初始化。
* /parameter\_events：ROS参数事件广播（ParameterEvent），用于动态参数变化通知。
* /rosout：ROS日志输出（Log），所有节点日志汇总。
* /tf：变换树（TFMessage），广播坐标系变换（如odom到map）。

## 2. Unitree机器人特定话题

这些似乎与Unitree B2的低级控制、状态和运动模式相关（Unitree SDK常用lowstate/sportmode等）。

* /bmsstate：电池管理系统状态（Battery Management System，推测为自定义消息，包含电量、电压等）。
* /control\_feedback：控制反馈（推测为运动控制器的反馈，如速度/位置）。
* /dog\_imu\_raw：原始IMU数据（Inertial Measurement Unit，狗形机器人如B2的IMU传感器数据）。
* /dog\_movement：狗形机器人运动命令或状态（推测为自定义，控制B2的步态/移动）。
* /dog\_odom：狗形机器人的里程计（Odometry），B2的轮式/腿式里程计输出。
* /gaitcmd：步态命令（Gait Command，控制机器人步态，如走/跑）。
* /lf/lowstate：左前腿（Left Front）的低级状态（LowState，Unitree标准消息，包含关节角度/扭矩）。
* /lf/odommodestate：左前腿的里程计模式状态（推测结合odom和mode）。
* /lf/sportmodestate：左前腿的运动模式状态（SportModeState，Unitree运动模式如站立/行走）。
* /lowcmd：低级命令（LowCmd，Unitree标准，发送关节/电机命令）。
* /lowstate：低级状态（LowState，Unitree核心消息，包含所有关节/IMU/脚力数据）。
* /multiplestate：多重状态（推测为聚合多个组件的状态）。
* /odommodestate：里程计模式状态（Odometry Mode State）。
* /ros\_sport\_mode\_cmd：ROS接口的运动模式命令（自定义，切换B2的sport模式）。
* /rosgaitcmd：ROS步态命令（Gait Command via ROS）。
* /sportmodestate：运动模式状态（SportModeState，Unitree标准，报告当前模式如行走/跳跃）。
* /sportmodestate\_nav：导航相关的运动模式状态（推测用于导航集成）。
* /unitree\_command：Unitree通用命令（推测为B2的高级命令接口）。

## 3. SLAM/定位/映射话题

这些大多来自LIO-SAM（LiDAR-Inertial Odometry via Smoothing and Mapping）包，用于SLAM。

* /lio\_sam\_ros2/deskew/cloud\_deskewed：去偏斜点云（Cloud Deskewed，LIO-SAM处理后的点云，去除运动畸变）。
* /lio\_sam\_ros2/mapping/InitialFlag：映射初始化标志（推测为bool标志，指示SLAM初始化）。
* /lio\_sam\_ros2/mapping/cloud\_registered：注册后的点云（Registered Cloud，SLAM配准后的点云）。
* /lio\_sam\_ros2/mapping/cloud\_registered\_z\_limit：Z轴限制的注册点云（推测为过滤Z高度的点云）。
* /lio\_sam\_ros2/mapping/map\_local：本地地图（Local Map，当前区域的点云地图）。
* /lio\_sam\_ros2/mapping/odometry：SLAM里程计（Odometry，从LiDAR/IMU计算）。
* /lio\_sam\_ros2/mapping/re\_location\_laser\_to\_map：重定位激光到地图（Relocation，激光帧到地图的变换）。
* /lio\_sam\_ros2/mapping/re\_location\_odometry：重定位里程计（Relocation Odometry）。
* /lio\_sam\_ros2/mapping/switchflag：切换标志（推测用于SLAM模式切换，如建图/定位）。
* /lio\_sam\_ros2/savepcd/savepcd\_flag：保存PCD标志（Point Cloud Data，触发保存点云文件）。
* /mapping/grid\_map：栅格地图（GridMap，SLAM生成的2D/3D地图）。
* /slam\_info：SLAM信息（推测为自定义，包含SLAM状态如精度/节点数）。
* /slam\_internal\_info：SLAM内部信息（更详细的调试数据）。
* /unitree/slam\_mapping/points：Unitree SLAM映射点云（PointCloud，建图过程中的点）。
* /unitree/slam\_relocation/points：Unitree SLAM重定位点云（用于回环检测或重定位）。

## 4. 导航/规划话题

这些与Nav2或自定义导航相关。

* /goal：目标位姿（PoseStamped，导航目标）。
* /goal\_single：单个目标（类似/goal，但可能简化版）。
* /local\_costmap/costmap：本地代价地图（OccupancyGrid，Nav2用于局部避障）。
* /mission\_points\_command：任务点命令（推测为路径点序列，如巡检任务）。
* /mission\_points\_command\_after：后续任务点命令（推测为链式任务）。
* /path\_success：路径成功标志（bool，指示规划是否成功）。

## 5. API和服务话题

这些是请求/响应风格的话题，可能用于服务调用（类似于ROS Action，但用话题实现）。

* /api/back\_videohub/request/response：后置视频集线器API请求/响应（Back Video Hub，控制后摄像头）。
* /api/bashrunner/request/response：Bash脚本运行器API（执行shell命令）。
* /api/config/request/response：配置API（修改系统配置）。
* /api/front\_videohub/request/response：前置视频集线器API（Front Video Hub）。
* /api/motion\_switcher/request/response：运动切换器API（切换运动模式）。
* /api/obstacles\_avoid/request/response：避障API（控制避障行为）。
* /api/robot\_state/request/response：机器人状态API（查询/设置状态）。
* /api/slam\_logic/request/response：SLAM逻辑API（控制SLAM流程）。
* /api/slam\_operate/request/response：SLAM操作API（如启动/停止建图）。
* /api/slam\_web\_server/request/response：SLAM Web服务器API（远程访问SLAM）。
* /api/sport/request/response：运动API（控制sport模式）。
* /api/sport\_lease/request/response：运动租赁API（推测为权限控制，如租借模式）。
* /config\_change\_status：配置变化状态（通知配置更新）。
* /node\_control：节点控制（推测启动/停止ROS节点）。
* /qt\_add\_edge/modify\_edge：QT相关（推测为图形界面，如添加/修改拓扑图边）。
* /qt\_add\_node/modify\_node：添加/修改节点（拓扑图节点）。
* /qt\_command：QT命令（界面命令）。
* /qt\_notice：QT通知（界面消息）。
* /query\_result\_edge/floor/node/pcd/topo：查询结果（边/楼层/节点/PCD/拓扑，推测为数据库查询）。

## 6. 传感器/视觉话题

* /back\_videohub/inner/videostream：后置视频内部/流（Image或CompressedImage，后摄像头数据）。
* /front\_videohub/inner/videostream：前置视频内部/流。
* /gnss：GNSS数据（NavSatFix，卫星导航位置）。
* /gps：GPS数据（类似/gnss，可能简化版）。
* /panorama\_videohub/videostream：全景视频流（Panorama）。
* /pctoimage\_local：点云到图像本地转换（推测将PCD转换为图像）。
* /rslidar\_points：RoboSense LiDAR点云（PointCloud2，Helios 5515等模型的输出）。
* /videohub/inner：通用视频集线器内部话题。
* /wirelesscontroller：无线控制器（推测为遥控器输入，如Joystick）。

## 7. 其他/杂项话题

* /EstimatorData：估计器数据（推测为状态估计，如EKF输出）。
* /SymState/SymState\_back：对称状态（前/后，推测为机器人对称组件状态）。
* /all\_edge/all\_node：所有边/节点（推测为拓扑图数据）。
* /original\_graph：原始图（Graph，SLAM或路径图）。
* /pcd\_id\_set：PCD ID集合（Point Cloud Data ID）。
* /pcdload\_state/pcdsave\_state：PCD加载/保存状态（加载/保存点云文件状态）。
* /point\_in\_map：地图中的点（PointStamped，查询点位置）。
* /public\_network\_status：公共网络状态（网络连接状态）。
* /rtc/ext\_service/rtc\_status：RTC（Real-Time Clock?）外部服务/状态（推测为实时钟或WebRTC相关）。
* /selftest：自检（SelfTest，节点健康检查）。
* /servicestate/servicestateactivate：服务状态/激活（推测服务管理）。
* /tf：已在上文（重复列出，可能系统有多个）。
* /to\_control：向控制器的消息（推测命令转发）。
* /up\_state\_feedback：上层状态反馈（高层控制反馈）。
* /webrtcreq/webrtcres：WebRTC请求/响应（用于实时通信，如视频流）。

## 总结和建议

* **整体系统**：这看起来是Unitree B2机器人的完整ROS2栈，集成SLAM（LIO-SAM）、导航、视觉（多摄像头）、低级控制（关节/运动）和API接口。焦点在SLAM/导航（如隧道场景）和机器人状态管理。
* **常见模式**：许多话题以/request/response结尾，表示服务式通信；LIO-SAM话题用于LiDAR-IMU融合SLAM；Unitree话题处理硬件特定控制。
* **如果不确定**：有些话题（如/qt\_xxx）可能来自自定义GUI或拓扑导航包。请运行`ros2 topic info <topic>`查看消息类型和发布者/订阅者，或分享节点列表（`ros2 node list`）以获取更多上下文。如果这些话题来自特定包（如dddmr\_navigation），请提供包文档或让我帮助调试。

如果您有特定话题的疑问、想查看echo输出，或需要代码调整，请提供更多细节！

# 获取摄像头视频流
主控PC（以下称为`PC1`）IP地址为`192.168.123.161`。  
用户PC（以下称为`PC2`）IP地址为`192.168.123.164`。  
加装了无线网卡用于连接WiFi，在连接**清华4F**的一个情况下IP地址为`172.16.20.203`。  
个人PC或websocket服务端（以下称为`PC3`）在连接**清华4F**的一个情况下IP地址为`172.16.20.206`。  
`PC2`的有线网卡设备id为`eth0`，无线网卡设备id为`wlx54e4bd61dd63`。  
机器狗的相机连接`PC1`，因此只能从`PC1`读到相机的视频流。  
前相机的视频流地址为：
```cmd
rtsp://192.168.123.161:8551/front_video
```
后相机的视频流地址为
```cmd
rtsp://192.168.123.161:8552/back_video
```
因此，想要从`PC3`中读到视频流，需要设置NAT规则并进行端口转发。  
简易的流量示意图如下：  
>PC3 (172.16.20.206)  
&emsp;&emsp;│  
&emsp;&ensp;&nbsp;▼  
PC2无线接口 (wlx54e4bd61dd63, 172.16.20.203)  
&emsp;&emsp;│  NAT转发  
&emsp;&ensp;&nbsp;▼    
PC2有线接口 (eth0, 192.168.123.164)  
&emsp;&emsp;│  
&emsp;&ensp;&nbsp;▼  
PC1 (192.168.123.161:8551/front_video)  

具体实现如下：
## 1.在 PC2 上启用 IP 转发​​
```bash
# 修改/etc/sysctl.conf文件
sudo gedit /etc/sysctl.conf
# 添加一行
net.ipv4.ip_forward=1
# 重新加载sysctl.conf文件
sudo sysctl -p
```
## 2.清除可能冲突的旧规则​​
在添加新规则前，可以先查看并清理之前设置的旧规则。
```bash
# 查看NAT表中现有的规则
sudo iptables -t nat -L -v -n --line-numbers
# 查看FORWARD链中现有的规则
sudo iptables -L FORWARD -v -n --line-numbers
# 根据列出的规则编号，删除相应的规则
## 删除DNAT规则
sudo iptables -t nat -D PREROUTING <规则编号>
## 删除SNAT规则
sudo iptables -t nat -D POSTROUTING <规则编号>
## 删除FORWARD规则
sudo iptables -D FORWARD <规则编号>
```
请将<规则编号>替换为想要删除规则对应的数字序号。
## 3.设置完整的NAT规则
```bash
# 1. DNAT：当PC3的包到达PC2的无线IP时，将其目标地址改为PC1
sudo iptables -t nat -A PREROUTING -i wlx54e4bd61dd63 -p tcp --dport 8551 -j DNAT --to-destination 192.168.123.161:8551
# 2. SNAT: 在包离开PC2前往PC1前，修改源地址为PC2的有线IP。这样PC1的回包就会发给PC2。
#    注意，这里我们匹配的是从无线网卡进来，从有线网卡出去，且目的地是PC1的包。
sudo iptables -t nat -A POSTROUTING -o eth0 -d 192.168.123.161 -p tcp --dport 8551 -j SNAT --to-source 192.168.123.164
# 3. SNAT: 在包从PC2返回给PC3前，修改源地址为PC2的无线IP。这样PC3会认为一直是和PC2通信。
#    注意，这里我们匹配的是从有线网卡进来，从无线网卡出去，且源地址是PC1的包。
sudo iptables -t nat -A POSTROUTING -o wlx54e4bd61dd63 -s 192.168.123.161 -p tcp --sport 8551 -j SNAT --to-source 172.16.20.203
```
8551为前相机使用的端口。对后相机，将8551改为8552再设置一遍即可。  
这里注意`PC2`的无线网卡ip地址可能会变，也需要修改。  
## 4.设置FORWORD规则允许流量通过
```bash
# 允许转发从无线到有线、去往PC1端口8551的请求包
sudo iptables -A FORWARD -i wlx54e4bd61dd63 -o eth0 -d 192.168.123.161 -p tcp --dport 8551 -j ACCEPT
# 允许转发从有线到无线、来自PC1端口8551的返回包
sudo iptables -A FORWARD -i eth0 -o wlx54e4bd61dd63 -s 192.168.123.161 -p tcp --sport 8551 -j ACCEPT
```
8551为前相机使用的端口。对后相机，将8551改为8552再设置一遍即可。  
## 5.保存配置
```bash
# 安装持久化工具（如果没有安装的话）
sudo apt install iptables-persistent -y
# 保存iptables规则
sudo netfilter-persistent save
```
## 6.防火墙配置
对于`PC2`和，确保它的防火墙允许8551和8552端口
```bash
sudo ufw allow 8551
sudo ufw allow 8552
```
## 7.在PC2上抓包监控流量
```bash
# 监听无线网卡
sudo tcpdump -i wlx54e4bd61dd63 host 172.16.20.206 and port 8551
# 监听有线网卡
sudo tcpdump -i eth0 host 192.168.123.161 and port 8551
```